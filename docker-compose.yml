services:
  keycloak:
    image: quay.io/keycloak/keycloak:26.0
    container_name: shopverse-keycloak
    command: start-dev --import-realm
    ports:
      - "8080:8080"
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
    volumes:
      - ./docker/keycloak/shopverse-realm.json:/opt/keycloak/data/import/shopverse-realm.json:ro

  # Kafka-compatible message broker (lightweight alternative to Apache Kafka)
  redpanda:
    image: docker.redpanda.com/redpandadata/redpanda:v24.1.1
    container_name: shopverse-redpanda
    command:
      - redpanda
      - start
      - --kafka-addr internal://0.0.0.0:9092,external://0.0.0.0:19092
      - --advertise-kafka-addr internal://redpanda:9092,external://localhost:19092
      - --pandaproxy-addr internal://0.0.0.0:8082,external://0.0.0.0:18082
      - --advertise-pandaproxy-addr internal://redpanda:8082,external://localhost:18082
      - --schema-registry-addr internal://0.0.0.0:8081,external://0.0.0.0:18081
      - --rpc-addr redpanda:33145
      - --advertise-rpc-addr redpanda:33145
      - --mode dev-container
      - --smp 1
      - --default-log-level=warn
    ports:
      - "19092:19092"  # Kafka API (external)
      - "18082:18082"  # Pandaproxy (HTTP API)
      - "18081:18081"  # Schema Registry
      - "9644:9644"    # Admin API

  # Redpanda Console (UI for viewing topics and messages)
  redpanda-console:
    image: docker.redpanda.com/redpandadata/console:v2.5.2
    container_name: shopverse-redpanda-console
    ports:
      - "8088:8080"
    environment:
      KAFKA_BROKERS: redpanda:9092
      REDPANDA_ADMINAPI_ENABLED: "false"
    restart: on-failure
    depends_on:
      - redpanda

  # Seq - Centralized structured log server
  seq:
    image: datalust/seq:latest
    container_name: shopverse-seq
    ports:
      - "5341:5341"  # Ingestion API
      - "8089:80"    # Web UI
    environment:
      ACCEPT_EULA: "Y"
      SEQ_FIRSTRUN_ADMINPASSWORD: "Admin123!"
    volumes:
      - seq-data:/data

  apigateway:
    image: shopverse-apigateway
    container_name: ShopVerse
    build:
      context: .
      dockerfile: ApiGateway/Dockerfile
    ports:
      - "8085:8085"
    environment:
      ASPNETCORE_ENVIRONMENT: Docker
      ASPNETCORE_HTTP_PORTS: 8085
      Seq__ServerUrl: http://seq:5341
    depends_on:
      - keycloak
      - seq
      - orders
      - payments
      - inventory

  orders:
    image: shopverse-orders
    build:
      context: .
      dockerfile: OrderService/Dockerfile
    ports:
      - "8090:8090"
    environment:
      ASPNETCORE_ENVIRONMENT: Docker
      ASPNETCORE_HTTP_PORTS: 8090
      Kafka__BootstrapServers: redpanda:9092
      Seq__ServerUrl: http://seq:5341
    depends_on:
      - keycloak
      - redpanda
      - seq

  payments:
    image: shopverse-payments
    build:
      context: .
      dockerfile: PaymentService/Dockerfile
    ports:
      - "8092:8092"
    environment:
      ASPNETCORE_ENVIRONMENT: Docker
      ASPNETCORE_HTTP_PORTS: 8092
      Kafka__BootstrapServers: redpanda:9092
      Seq__ServerUrl: http://seq:5341
    depends_on:
      - keycloak
      - redpanda
      - seq

  inventory:
    image: shopverse-inventory
    build:
      context: .
      dockerfile: InventoryService/Dockerfile
    ports:
      - "8094:8094"
    environment:
      ASPNETCORE_ENVIRONMENT: Docker
      ASPNETCORE_HTTP_PORTS: 8094
      Kafka__BootstrapServers: redpanda:9092
      Seq__ServerUrl: http://seq:5341
    depends_on:
      - keycloak
      - redpanda
      - seq

volumes:
  seq-data:
